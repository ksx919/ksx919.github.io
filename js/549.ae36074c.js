"use strict";(self["webpackChunkaihub"]=self["webpackChunkaihub"]||[]).push([[549],{9549:function(a,e,t){t.r(e),t.d(e,{default:function(){return j}});var l=t(6768),s=t(4232),n=t(5130);const u={class:"chat-pdf-layout"},c={class:"sidebar"},r={class:"chat-list"},i=["onClick"],d={class:"chat-summary"},o={class:"chat-time"},v={class:"chat-main"},p=["title"],h={key:0,class:"content-area"},f={class:"pdf-viewer-container"},m=["src"],k={class:"chat-window"},y={class:"chat-history-area"},g={class:"messages"},w={class:"message-avatar"},L={key:0,class:"user-avatar"},C={key:1,class:"ai-avatar"},b={class:"message-content"},D={key:0,class:"user-message"},I={class:"text"},E={key:0,class:"loading-dots"},F={key:1,class:"ai-response"},R=["innerHTML"],K={class:"input-bar-container"},x={class:"input-wrapper"},T=["disabled"],P={class:"input-actions"},U=["disabled"],X={key:0},$={key:1},H={key:1,class:"pdf-upload-area"};function A(a,e,t,A,_,M){return(0,l.uX)(),(0,l.CE)("div",u,[(0,l.Lk)("aside",c,[e[8]||(e[8]=(0,l.Lk)("div",{class:"sidebar-header"},[(0,l.Lk)("h2",null,"PDF聊天"),(0,l.Lk)("p",{class:"subtitle"},"智能文档助手")],-1)),(0,l.Lk)("div",r,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(A.chatList,a=>((0,l.uX)(),(0,l.CE)("div",{key:a.chatId,class:(0,s.C4)(["chat-item",a.chatId===A.currentChatId?"active":""]),onClick:e=>A.switchChat(a.chatId)},[(0,l.Lk)("div",d,(0,s.v_)(a.summary||"（空会话）"),1),(0,l.Lk)("div",o,(0,s.v_)(A.formatTime(a.createTime)),1)],10,i))),128))]),(0,l.Lk)("button",{class:"new-chat-btn",onClick:e[0]||(e[0]=(...a)=>A.newChat&&A.newChat(...a))},"+ 新建会话")]),(0,l.Lk)("main",v,[(0,l.Lk)("div",{class:(0,s.C4)(["chat-header",{collapsed:A.isHeaderCollapsed}])},[e[9]||(e[9]=(0,l.Fv)('<div class="header-content" data-v-3fa0dc0a><h1 data-v-3fa0dc0a>PDF智能助手</h1><div class="features" data-v-3fa0dc0a><span class="feature-tag" data-v-3fa0dc0a>文档解析</span><span class="feature-tag" data-v-3fa0dc0a>内容问答</span><span class="feature-tag" data-v-3fa0dc0a>要点提取</span><span class="feature-tag" data-v-3fa0dc0a>智能总结</span></div></div>',1)),(0,l.Lk)("button",{class:"collapse-btn",onClick:e[1]||(e[1]=(...a)=>A.toggleHeader&&A.toggleHeader(...a)),title:A.isHeaderCollapsed?"展开标题":"收起标题"},(0,s.v_)(A.isHeaderCollapsed?"▼":"▲"),9,p)],2),A.pdfUrl?((0,l.uX)(),(0,l.CE)("div",h,[(0,l.Lk)("div",f,[(0,l.Lk)("iframe",{src:A.pdfUrl,class:"pdf-viewer",frameborder:"0"},null,8,m)]),(0,l.Lk)("div",k,[(0,l.Lk)("div",y,[(0,l.Lk)("div",g,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(A.currentMessages,(a,t)=>((0,l.uX)(),(0,l.CE)("div",{key:t,class:(0,s.C4)(["message",a.role])},[(0,l.Lk)("div",w,["user"===a.role?((0,l.uX)(),(0,l.CE)("div",L,"👤")):((0,l.uX)(),(0,l.CE)("div",C,"🤖"))]),(0,l.Lk)("div",b,["user"===a.role?((0,l.uX)(),(0,l.CE)("div",D,[(0,l.Lk)("span",I,(0,s.v_)(a.text),1)])):((0,l.uX)(),(0,l.CE)(l.FK,{key:1},[A.loading&&t===A.currentMessages.length-1&&!a.text?((0,l.uX)(),(0,l.CE)("div",E,e[10]||(e[10]=[(0,l.Lk)("span",{class:"dot"},null,-1),(0,l.Lk)("span",{class:"dot"},null,-1),(0,l.Lk)("span",{class:"dot"},null,-1)]))):(0,l.Q3)("",!0),a.text?((0,l.uX)(),(0,l.CE)("div",F,[(0,l.Lk)("div",{class:"response-text",innerHTML:A.formatResponse(a.text)},null,8,R)])):(0,l.Q3)("",!0)],64))])],2))),128))])]),(0,l.Lk)("div",K,[(0,l.Lk)("div",x,[(0,l.bo)((0,l.Lk)("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>A.input=a),onInput:e[3]||(e[3]=(...a)=>A.autoResizeInput&&A.autoResizeInput(...a)),onKeydown:e[4]||(e[4]=(...a)=>A.handleKeydown&&A.handleKeydown(...a)),placeholder:"请输入您的问题...",disabled:A.loading||!A.pdfUrl,class:"chat-input textarea-auto",rows:"1",style:{resize:"none",overflow:"hidden"}},null,40,T),[[n.Jo,A.input]]),(0,l.Lk)("div",P,[(0,l.Lk)("button",{onClick:e[5]||(e[5]=(...a)=>A.send&&A.send(...a)),disabled:A.loading||!A.pdfUrl||!A.input.trim(),class:"send-btn"},[A.loading?((0,l.uX)(),(0,l.CE)("span",X,"发送中...")):((0,l.uX)(),(0,l.CE)("span",$,"发送"))],8,U)])])])])])):(0,l.Q3)("",!0),A.pdfUrl?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",H,[(0,l.Lk)("div",{class:"upload-placeholder",onClick:e[6]||(e[6]=e=>a.$refs.fileInput.click())},e[11]||(e[11]=[(0,l.Lk)("p",null,"点击上传PDF文件",-1),(0,l.Lk)("p",{class:"upload-hint"},"支持PDF格式文件",-1)])),(0,l.Lk)("input",{type:"file",ref:"fileInput",onChange:e[7]||(e[7]=(...a)=>A.handleFileUpload&&A.handleFileUpload(...a)),accept:".pdf",style:{display:"none"}},null,544)]))])])}t(4114),t(8111),t(116),t(1701);var _=t(144),M=t(4373);function z(){return"chat_"+Date.now()+"_"+Math.random().toString(36).slice(2,8)}var Q={name:"ChatPDF",setup(){const a=(0,_.KR)([]),e=(0,_.KR)(""),t=(0,_.KR)(""),s=(0,_.KR)(!1),n=(0,_.KR)([]),u=(0,_.KR)(""),c=(0,_.KR)(""),r=(0,_.KR)(!1),i=(0,_.KR)({}),d=(0,_.KR)({}),o=(0,_.KR)({}),v=async()=>{try{const l=await M.A.get("/ai/history/pdf/with-time"),s=l.data,n=[];for(const[a,e]of Object.entries(s))try{const t=`${M.A.defaults.baseURL}/ai/pdf/file/${a}`,l=await fetch(t,{method:"HEAD"});let s="（空会话）";l.ok&&(s=`PDF_${a.substring(0,8)}.pdf`),n.push({chatId:a,summary:s,createTime:e})}catch(t){n.push({chatId:a,summary:"（空会话）",createTime:e})}n.sort((a,e)=>e.createTime-a.createTime),a.value=n,a.value.length>0&&!e.value&&(e.value=a.value[0].chatId)}catch(t){console.error("获取会话列表失败:",t)}},p=async a=>{if(a)try{const l=await M.A.get(`/ai/history/pdf/${a}`),s=l.data.map(a=>"assistant"===a.role?{role:"ai",text:a.content}:{role:"user",text:a.content});i.value[a]=s,a===e.value&&(n.value=s,m());try{const t=`${M.A.defaults.baseURL}/ai/pdf/file/${a}`,l=await fetch(t,{method:"HEAD"});if(l.ok){const l={url:t,name:`PDF_${a.substring(0,8)}.pdf`};o.value[a]=l,a===e.value&&(u.value=l.url,c.value=l.name)}}catch(t){console.debug("检查PDF文件是否存在时出错:",t)}o.value[a]&&(u.value=o.value[a].url,c.value=o.value[a].name)}catch(l){console.error("获取消息失败:",l)}},h=async()=>{const a=z();e.value=a,i.value[a]=[],n.value=[],u.value="",c.value="",o.value[a]={url:"",name:""}},f=async t=>{if(e.value=t,i.value[t]){if(n.value=i.value[t],o.value[t])u.value=o.value[t].url,c.value=o.value[t].name;else try{const e=`${M.A.defaults.baseURL}/ai/pdf/file/${t}`,l=await fetch(e,{method:"HEAD"});if(l.ok){const l={url:e,name:`PDF_${t.substring(0,8)}.pdf`};o.value[t]=l,u.value=l.url,c.value=l.name;const s=a.value.find(a=>a.chatId===t);s&&(s.summary=l.name)}}catch(l){console.debug("检查PDF文件是否存在时出错:",l)}m()}else await p(t)},m=()=>{setTimeout(()=>{const a=document.querySelector(".messages");a&&(a.scrollTop=a.scrollHeight)},10)},k=a=>{if(a){const e=new Date(a);return e.toLocaleDateString()+" "+e.toLocaleTimeString()}return""},y=a=>a?a.replace(/\n/g,"<br>"):"",g=()=>{r.value=!r.value},w=async t=>{e.value||await h();const l=t.target.files[0];if(!l||"application/pdf"!==l.type)return void alert("请选择PDF文件");const s=104857600;if(l.size>s)return alert("文件大小不能超过100MB"),void(t.target.value="");const n=new FormData;n.append("file",l);try{const s=await M.A.post(`/ai/pdf/upload/${e.value}`,n,{headers:{"Content-Type":"multipart/form-data"}});if(1!==s.data.ok)throw new Error(s.data.msg||"上传失败");const r=e.value,i={url:`${M.A.defaults.baseURL}/ai/pdf/file/${r}`,name:l.name};o.value[r]=i,u.value=i.url,c.value=i.name;const d=a.value.find(a=>a.chatId===r);d&&(d.summary=l.name),t.target.value=""}catch(r){console.error("上传PDF失败:",r),alert("上传PDF失败，请重试")}},L=()=>{u.value="",c.value="";const t=e.value;if(o.value[t]){o.value[t]={url:"",name:""};const e=a.value.find(a=>a.chatId===t);e&&(e.summary="（空会话）")}},C=async()=>{if(!t.value.trim()||s.value||!u.value)return;const l=e.value,c=t.value;t.value="",d.value[l]=!0,s.value=!0;let r=i.value[l]||[];if(0===r.length){const e=Date.now();a.value.unshift({chatId:l,summary:c.slice(0,20)+(c.length>20?"...":""),createTime:e})}else{const e=a.value.find(a=>a.chatId===l);e&&(e.createTime=Date.now())}r.push({role:"user",text:c}),i.value[l]=r,r.push({role:"ai",text:""}),i.value[l]=r,l===e.value&&(n.value=r,m()),b(l,c,r)},b=async(a,t,l)=>{try{const s=M.A.getUri({url:"/ai/pdf/chat",params:{prompt:t,chatId:a}}),u=await fetch(s);if(!u.body)throw new Error("无流式响应");const c=u.body.getReader(),r=new TextDecoder("utf-8");let d="";const o=l.length-1;while(1){const{done:t,value:s}=await c.read();if(t)break;const u=r.decode(s,{stream:!0});d+=u,l[o].text=d,i.value[a]=[...l],a===e.value&&(n.value=[...l],m())}await v()}catch(u){const t=l.length-1;l[t]={role:"ai",text:`[AI异常] ${u.message||"未知错误"}`},i.value[a]=[...l],a===e.value&&(n.value=[...l],m())}finally{d.value[a]=!1,a===e.value&&(s.value=!1)}},D=a=>{if("Enter"===a.key){if(a.shiftKey)return;a.preventDefault(),C()}},I=a=>{const e=a.target;e.style.height="auto",e.style.height=e.scrollHeight+"px"};return(0,l.sV)(async()=>{await v(),e.value&&await p(e.value)}),{chatList:a,currentChatId:e,currentMessages:n,input:t,send:C,newChat:h,switchChat:f,loading:s,pdfUrl:u,currentPdfName:c,handleFileUpload:w,closePdf:L,autoResizeInput:I,formatTime:k,formatResponse:y,isHeaderCollapsed:r,toggleHeader:g,handleKeydown:D}}},S=t(1241);const V=(0,S.A)(Q,[["render",A],["__scopeId","data-v-3fa0dc0a"]]);var j=V}}]);
//# sourceMappingURL=549.ae36074c.js.map